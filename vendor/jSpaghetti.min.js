(function(){const LAST_COMMAND_TERMINATED="lastCommandTerminated",SEQUENCE_RELEASED="sequenceReleased",PAGE_IS_ABOUT_TO_RELOAD="beforeunload",SEQUENCE_TERMINATED="terminated",SEQUENCE_ERROR="error",SEQUENCE_RESET="reset",STORAGE_NAME='"jSpaghetti:" + moduleName + ":" + sequenceName',EXIT_COMMAND="exit",GOTOIF_COMMAND="jumpif",WAIT_COMMAND="wait",WAIT_FOR_PAGE_TO_RELOAD="page-reload",INTERNAL_OBJECT_COMMANDS_LIST=[WAIT_COMMAND,GOTOIF_COMMAND,EXIT_COMMAND],DEFAULT_DELAY=10;function Route(e,t){this.instruction=e,this.command=t}function State(e,t,n,r){this.route=e,this.shared=t,this.lastProcedureRoute=n,this.callLastProcedure=r}function getFirstAttribName(e){return Object.keys(e)[0]}function getInstructionByRoute(e,t){var n=getFirstAttribName(e[t.instruction]);return{label:n,commands:e[t.instruction][n]}}function getCommandByRoute(e,t){return getInstructionByRoute(e,t).commands[t.command]}function getNextRoute(e,t){var n=getInstructionByRoute(e,t).commands,r=new Route(t.instruction,t.command);return t.command<n.length-1?r.command+=1:t.instruction<e.length-1?(r.instruction+=1,r.command=0):r=null,r}function getInstructionPosByLabel(e,t){for(var n=0;n<t.length;n++)if(t[n].hasOwnProperty(e))return n;return!1}function checkInstructionsSyntax(e,t){if(e.length>0){for(var n=0;n<e.length;n++){var r=getFirstAttribName(e[n]);"[object Array]"!=Object.prototype.toString.call(e[n][r])&&(e[n][r]=[e[n][r]]);for(var u=0;u<e[n][r].length;u++)switch(typeof e[n][r][u]){case"object":var s=getFirstAttribName(e[n][r][u]);if(-1==INTERNAL_OBJECT_COMMANDS_LIST.indexOf(s))return'Internal command "'+s+'" is undefined';var o=e[n][r][u][s];if(s==EXIT_COMMAND||s==WAIT_COMMAND){if("object"==typeof o)return'Label "'+getFirstAttribName(o)+'" is undefined'}else if(s==GOTOIF_COMMAND){if("[object Array]"!=Object.prototype.toString.call(o))return'Internal command "'+s+'" must receive an array';if(o.length<2)return'Internal command "'+s+'" must receive an array that must have at least 2 positions';for(var c=1;c<o.length;c++){var a=o[c];if(!1===getInstructionPosByLabel(a,e)&&a!=EXIT_COMMAND)return'Instruction label "'+a+'" is undefined'}}break;default:var i=e[n][r][u];if(!t.hasOwnProperty(i)&&i!=EXIT_COMMAND)return'Procedure "'+i+'" is undefined'}}return!0}return"There are no instructions to be executed"}function throwErrorNotification(e,t,n,r){console.error("jSpaghetti error:",e,t),n&&n.dispatchEvent(r)}function showDebugMessage(e,t){console.log("jSpaghetti debug:",e,t)}function evaluateExpression(expression,shared){const STORAGETOKEN=/\*|SHARED/g;expression=String(expression).replace(STORAGETOKEN,"shared");var result=eval(expression);return result}function getSharedFunctions(e,t){return{next:function(n){const r=()=>{jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Next called ("+e+":"+t+"): ",n),jSpaghetti.modules[e].sequences[t].events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED,jSpaghetti.modules[e].sequences[t]))};if(jSpaghetti.modules[e].sequences[t].state.callLastProcedure=!1,jSpaghetti.modules[e].sequences[t].state.shared.$=n,jSpaghetti.modules[e].sequences[t].released)r();else{const n=setInterval((()=>{jSpaghetti.modules[e].sequences[t].released&&(clearInterval(n),r())}),5*DEFAULT_DELAY)}},getObjectSnapshot:getObjectSnapshot}}function dispatchExitCommand(e,t){jSpaghetti.modules[e].sequences[t].state.route=null,jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Exit command dispatched ("+e+":"+t+")"," ")}function getObjectSnapshot(e){return"object"==typeof e&&JSON.parse(JSON.stringify(e))}function getEvent(e,t){return new CustomEvent(e,{detail:t})}function startStateSaver(){window.addEventListener(PAGE_IS_ABOUT_TO_RELOAD,(function(event){for(var moduleName in jSpaghetti.state.ready=!1,jSpaghetti.modules)for(var sequenceName in jSpaghetti.modules[moduleName].sequences){var localStorage=new jSpaghetti.Storage(eval(STORAGE_NAME));localStorage.set(jSpaghetti.modules[moduleName].sequences[sequenceName].state,(function(){}))}}))}function runAssyncronously(e){setTimeout((function(){e()}),0)}var jSpaghetti={state:{ready:!0,running:!1},version:"0.1.6",modules:{},module:function(moduleName){var currentModule=jSpaghetti.modules[moduleName],module={name:moduleName,config:{debugMode:!1,developerMode:!1},sequences:{},procedures:{},procedure:function(e,t){currentModule.procedures[e]=t},sequence:function(sequenceName){var currentSequence=currentModule.sequences[sequenceName],initialRoute=new Route(0,0),initialState=new State(initialRoute,{},null,!1),sequence={name:sequenceName,hooks:getSharedFunctions(moduleName,sequenceName),module:currentModule,events:document.createDocumentFragment(),state:initialState,released:!0,instructions:[],run:function(lastState){setTimeout((function(){if(jSpaghetti.state.ready){jSpaghetti.state.running||(jSpaghetti.state.running=!0,startStateSaver());var resultSyntaxCheck=checkInstructionsSyntax(currentSequence.instructions,currentModule.procedures),runNextCommand=function(e){if(e&&(currentSequence.state=e),currentSequence.state.route&&!0===resultSyntaxCheck){currentSequence.state.callLastProcedure&&(currentSequence.state.callLastProcedure=!1,currentSequence.state.route=currentSequence.state.lastProcedureRoute);var t=getCommandByRoute(currentSequence.instructions,currentSequence.state.route),n=currentSequence.state.route.command,r=getInstructionByRoute(currentSequence.instructions,currentSequence.state.route).label,u=getNextRoute(currentSequence.instructions,currentSequence.state.route);switch(typeof t){case"object":switch(Object.keys(t)[0]){case WAIT_COMMAND:if(t[WAIT_COMMAND]==WAIT_FOR_PAGE_TO_RELOAD)currentSequence.state.route=u,currentModule.config.debugMode&&showDebugMessage("Waiting for page to reload ("+moduleName+":"+sequenceName+":"+r+":"+n+")"," ");else{var s=evaluateExpression(t[WAIT_COMMAND],currentSequence.state.shared);currentModule.config.debugMode&&showDebugMessage("Waiting "+s+" ms ("+moduleName+":"+sequenceName+":"+r+":"+n+")"," ");var o=0,c=setInterval((function(){o++,(!currentSequence.state.route||o>=s/DEFAULT_DELAY)&&(clearInterval(c),currentSequence.state.route?currentSequence.state.route=u:currentModule.config.debugMode&&showDebugMessage("Wait process was abruptly interrupted ("+moduleName+":"+sequenceName+")"," "),currentSequence.events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED,currentSequence)))}),DEFAULT_DELAY)}break;case GOTOIF_COMMAND:if(evaluateExpression(t[GOTOIF_COMMAND][0],currentSequence.state.shared)){currentModule.config.debugMode&&showDebugMessage("Gotoif returned true ("+moduleName+":"+sequenceName+":"+r+":"+n+")"," ");var a=t[GOTOIF_COMMAND][1];currentSequence.state.route.command=0,currentSequence.state.route.instruction=getInstructionPosByLabel(t[GOTOIF_COMMAND][1],currentSequence.instructions)}else if(currentModule.config.debugMode&&showDebugMessage("Gotoif returned false ("+moduleName+":"+sequenceName+":"+r+":"+n+")"," "),t[GOTOIF_COMMAND].length>2){a=t[GOTOIF_COMMAND][2];currentSequence.state.route.command=0,currentSequence.state.route.instruction=getInstructionPosByLabel(t[GOTOIF_COMMAND][2],currentSequence.instructions)}else currentSequence.state.route=u;a&&currentModule.config.debugMode&&showDebugMessage('Flow redirected to "'+a+'" ('+moduleName+":"+sequenceName+")"," "),currentSequence.events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED,currentSequence));break;case EXIT_COMMAND:evaluateExpression(t[EXIT_COMMAND],currentSequence.state.shared)?(currentModule.config.debugMode&&showDebugMessage("Exit returned true ("+moduleName+":"+sequenceName+":"+r+":"+n+")"," "),dispatchExitCommand(moduleName,sequenceName)):(currentModule.config.debugMode&&showDebugMessage("Exit returned false ("+moduleName+":"+sequenceName+":"+r+":"+n+")"," "),currentSequence.state.route=u),currentSequence.events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED,currentSequence))}break;default:currentSequence.state.lastProcedureRoute=new Route(currentSequence.state.route.instruction,currentSequence.state.route.command),currentSequence.state.route=u,currentModule.config.debugMode&&showDebugMessage("Running command",'"'+moduleName+":"+sequenceName+":"+r+":"+n+":"+t+'"'),currentSequence.released=!1,currentSequence.state.callLastProcedure=!0,runAssyncronously((function(){try{const e=currentModule.procedures[t](currentSequence.state.shared,currentSequence.hooks);void 0!==e?(currentSequence.state.callLastProcedure=!1,currentSequence.state.shared.$=e,currentSequence.events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED,currentSequence))):currentSequence.events.dispatchEvent(getEvent(SEQUENCE_RELEASED,currentSequence))}catch(e){let u=e+" ("+moduleName+":"+sequenceName+":"+r+":"+n+":"+t+")";throwErrorNotification(u," ",currentSequence.events,getEvent(SEQUENCE_ERROR,u))}}))}}else if(!0!==resultSyntaxCheck){let e=resultSyntaxCheck+" ("+moduleName+":"+sequenceName+")";throwErrorNotification(e," ",currentSequence.events,getEvent(SEQUENCE_ERROR,e))}else null==currentSequence.state.route&&(currentModule.config.debugMode&&showDebugMessage("Sequence is terminated ("+moduleName+":"+sequenceName+")"," "),currentSequence.events.dispatchEvent(getEvent(SEQUENCE_TERMINATED,currentSequence)))};if(lastState)currentModule.config.developerMode&&showDebugMessage("Data recovered from the last state ("+moduleName+":"+sequenceName+"): ",getObjectSnapshot(currentSequence.state)),runNextCommand(lastState);else{var localStorage=new jSpaghetti.Storage(eval(STORAGE_NAME));localStorage.get((function(e){e?(currentModule.config.developerMode&&showDebugMessage("Data recovered from the local storage ("+moduleName+":"+sequenceName+"): ",getObjectSnapshot(e)),e.shared&&(e.shared={...currentSequence.state.shared,...e.shared}),runNextCommand(e)):(currentModule.config.developerMode&&showDebugMessage("Data recovered from the initial state ("+moduleName+":"+sequenceName+"): ",getObjectSnapshot(currentSequence.state)),runNextCommand(currentSequence.state))}))}}else currentModule.config.developerMode&&showDebugMessage("jSpaghetti is not ready: Probably the page is about to be reloaded ("+moduleName+":"+sequenceName+")"," ")}),DEFAULT_DELAY)},reset:function(callback){currentSequence.state.route=null,setTimeout((function(){var routeReset=new Route(0,0);currentSequence.state=new State(routeReset,{$:void 0},null,!1);var localStorage=new jSpaghetti.Storage(eval(STORAGE_NAME));localStorage.reset((function(){callback&&callback(currentSequence)})),currentModule.config.debugMode&&showDebugMessage("Sequence is reset ("+moduleName+":"+sequenceName+")"," "),currentSequence.events.dispatchEvent(getEvent(SEQUENCE_RESET,currentSequence))}),5*DEFAULT_DELAY)}};return sequence.events.addEventListener(LAST_COMMAND_TERMINATED,(e=>{e.stopPropagation(),currentModule.sequences[sequenceName].events.dispatchEvent(getEvent(SEQUENCE_RELEASED,currentModule.sequences[sequenceName])),currentModule.config.developerMode&&showDebugMessage("Last command terminated event dispatched ("+moduleName+":"+sequenceName+"): ",getObjectSnapshot(currentSequence.state)),currentModule.sequences[sequenceName].run(currentSequence.state)})),sequence.events.addEventListener(SEQUENCE_RELEASED,(e=>{e.stopPropagation(),currentModule.config.developerMode&&showDebugMessage("Procedure released event dispatched ("+moduleName+":"+sequenceName+"): ",getObjectSnapshot(currentSequence.state)),currentModule.sequences[sequenceName].released=!0})),null==currentSequence&&(currentModule.sequences[sequenceName]=sequence,currentSequence=currentModule.sequences[sequenceName]),currentModule.sequences[sequenceName]}};return null==currentModule&&(jSpaghetti.modules[moduleName]=module,currentModule=jSpaghetti.modules[moduleName]),currentModule},Storage:function(e){this.get=function(t){t&&runAssyncronously((function(){t(JSON.parse(sessionStorage.getItem(e)))}))},this.set=function(t,n){n&&runAssyncronously(n),sessionStorage.setItem(e,JSON.stringify(t))},this.reset=function(t){t&&runAssyncronously(t),sessionStorage.removeItem(e)}}};$jSpaghetti=jSpaghetti})();